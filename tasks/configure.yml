---
- include:  configure-bridge.yml
  when:     "'name' in libvirtd_bridge"

#- include:  configure-nat.yml
#  when:     "'name' in libvirtd_nat"

- include:  configure-lvm-disks.yml

- name: "Opening port 80 for dmz"
  firewalld:
    zone:       dmz
    service:    http
    permanent:  yes
    state:      enabled

- name: "Opening port 80 for dmz"
  firewalld:
    zone:       dmz
    interface:  virbr0
    permanent:  yes
    state:      enabled
  register:     libvirtd_firewall_dmz

- name: "Reloading"
  command:  firewall-cmd --reload
  when: libvirtd_firewall_dmz.changed

## Serial communications setup
- name: Find tty group ID
  shell: egrep '^tty' /etc/group | awk -F':' '{ print $3 }'
  register: tty_group

- assert: that="{{ tty_group.stdout|trim|int }}"

- name: Alter pts for tty writable permissions, else you'll have no console
  lineinfile:
    dest:   /etc/fstab
    regexp: '^devpts\s+([^\s]+)\s+devpts\s+defaults((?:\s+\d){2}\s*)$'
    line:   'devpts{{ "\t" }}\1{{ "\t" }}devpts{{ "\t" }}defaults,gid={{ tty_group.stdout|trim }},mode=770\2'
    backrefs: yes
  register:   replaced_devpts

- name: Remount devpts if changed
  command:  mount -o remount /dev/pts
  when:   replaced_devpts.changed
